> Node即学即用
> Node:Up and Running
> 2013年1月第一次印刷

# 目录

# 第一部分 基础入门

## 第1章 Node.js简介

许多人将 JavaScript 用在前端网站应用开发上。Node.js 将这一流行编程语言扩展到了更多的领域，特别是后端网站服务器开发。Node 有几个重要的特性值得关注。

Node 是对高性能 V8 引擎的封装，通过提供一系列优化的 API 类库，使 V8 在浏览器之外依然能高效运行。比如，在服务器端开发程序常常需要处理二进制文件，JavaScript 语言本身对此支持得不好。因此 V8 也如此，而 Node 的Buffer 类库提供了轻松操作二进制数据的方法。使用 Node，除了可以直接操作 V8 的 JavaScript 运行时状态，还能在开发上得到更多益处。

Node 的一大特性是对高性能的追求。首先，V8 采用了编译领域的一些最新技术，使得用 JavaScript 等高级语言编写的代码再运行效率上能够接近用 C 等底层语言编写的代码，并且开发成本有所降低。

其次，Node 利用了 JavaScript 的事件驱动特性来构建高度可扩展的服务器程序。Node 采用了事件循环架构，让开发高效的服务器程序变得简单和安全。Node 提供了一系列“非阻塞”函数库来支持事件循环特性。

Node REPL。Node 是服务器程序，了解 Node.js 的最佳方案是使用其提供的 REPL 模式（Read-EvaluatePrint-Loop， 输入 - 求值 - 输出 - 循环），即交互式命令行解析器。可以在 Node 命令解析器中试验代码片段，同时如果想要运行一个 Node 程序时，可以用任何文本编辑器写好并保存成文件，然后运用`node filename.js`。它提供了以点号（.） 开头的元命令。如`.help`会显示帮助菜单，`.clear`会清除当前运行的内容，`.exit`将退出 Node 解析器。 其中最有用的命令是`.clear`， 它会清除内存中任何变量或闭包， 而不需要重启解析器。

## 第2章 编写有趣的应用

### 2.1 创建一个聊天服务器

首先，我们需要在 Node 中包含 TCP 模块，并创建一个新的 TCP 服务器。其中，net模块包含了 Node 需要的所有 TCP 功能。

```JavaScript
var net = require('net')
var chatServer = net.createServer()
chatServer.on('connection', function(client) {
  client.write('Hi!\n');
  client.write('Bye!\n');
  client.end()
})
chatServer.listen(9000)
```

### 2.2 我们也来编写个Twitter

首先，我们需要安装 Express 模块，这个针对 Node 的 Web 框架为现有的 http 服务器模块添加了更多的扩展（如MVC），使开发 Web 应用更加简单。

```JavaScript
var express = require('express')
var app = express.createServer()
app.get('/', function(req, res) {
  res.send('Welcome to Node Twitter')
})
app.listen(8000)
```

## 第3章 编写健壮的Node程序

### 3.1 事件循环

Node 的一个核心功能就是事件循环，这一概念也多用于 JavaScript 底层行为及许多交互系统中。在许多语言中，事件模型是在外层的，但 JavaScript 事件一直是其语言的核心模块，这是因为 JavaScript 在很多情景下都需要处理与用户交互的事件。在服务器端，没有了网页 DOM 对应的那些有限的用户驱动型交互事件，而是在服务器程序上对应发生的各种不同的事件，比如 HTTP 服务器模块在用户发送请求给 Web 服务器时会触发 request 事件。

JavaScript 利用事件循环来合理地处理系统各部分的请求。Node 采用的方式时，所有的 I/O 事件都应该是非阻塞的。这意味着需要让程序暂停操作的 HTTP 请求、数据库查询、文件读写，以及其他事件在数据返回之前并不暂停执行。这些事件都将独立运行，然后在数据准备好以后触发一个事件。也就是说，用 Node.js 编程会用到很多回调函数，来处理各种 I/O。回调函数往往以级联的方式嵌在其他回调函数中，这与浏览器编程有所不同。除了用顺序的方式设置好启动项外，大部分代码都是在处理回调函数。

### 3.2 模式

I/O 问题。首先要查看的是串行与并行 I/O 间的明显区别。串行很简单，即先进行一个 I/O 操作，完成以后，再做下一个，并行实现起来比较复杂，但也不难理解，即同时进行两个 I/O 操作。重点是，在串行任务中通常完成顺序是确定的，而在并行任务中任何一个操作先完成返回都是有可能的。

# 第二部分 API和常用模块

## 第4章 核心API

### 4.1 Events

因为在浏览器中 Event 模型是绑定在 DOM 上的，所以 Node 创建了 EventEmitter 类来提供基础的事件功能。所有 Node 的事件功能围绕着 EventEmitter，因为它的设计包含了其他类扩展所需要的接口类。EventEmitter 对象通常不会直接调用。

EventEmitter 类提供了一系列方法，其中最主要的两个是 on 和 emit，这些方法供其他类使用。on 方法为一个事件创建了监听器。on 方法接受两个参数：需要监听的事件的名称和当事件触发时需要调用的函数。

```JavaScript
server.on('event', function(a, b, c) {
  // 具体操作
});
```

### 4.2 HTTP

Node.js 的核心功能之一就是作为 Web 服务器，这是这个系统的一个重要部分。HTTP 使用的模式在 Node 里很常见。父工厂类提供了很容易创建新服务器的方法。`http.creatServer()`方法提供了构建新的 HTTPServer 类的实例。

### 4.3 I/O

I/O 是 Node 有别于其他框架的核心模块之一。

Node 中的许多组件提供了连续输出或可持续处理输入的功能。为了让这些组件行为一致，Stream API 提供了一个抽象的接口。该 API 提供了常用的方法，以及数据流具体实现时需要使用的属性。数据流分为可读、可写和可读写。所有的流都是 EventEmitter 的实例，也就是说可以主动触发事件。

## 第5章 工具类API

### 5.1 DNS

和普通用户一样，程序员一般都希望用域名来代替 IP 地址作为事物的引用名称。DNS 模块就提供了这种查找的功能，也为那些使用域名的模块提供支持，如 HTTP 客户端。

DNS 模块包含了两个主要方法，以及一些便利的方法。这两个主要方法使`resolve()`和`reverse()`，前者把域名转换成 DNS 记录，后者把 IP 地址转换成域名。DNS 模块的其他方法都是这两种方法的特殊形式。

### 5.2 加密

加密在许多领域都会用到，Node 的加密算法是以 OpenSSL 库为基础的，这是因为 OpenSSL 的加密算法经过了充分测试，并且有着良好的实现。但需要在编译 Node 的时候指定添加 OpenSSL 支持，才能使用下面方法。

### 5.3 进程

Node 中可以使用系统中已经存在的进程，或者创建新的子进程来做各种工作。虽然 Node 本身是一个“胖”进程，带有单独一个事件循环，但可以任意地开启其他进程（线程）在事件循环外工作。

### 5.4 用assert来测试

assert 是为测试代码提供基础功能的核心库。Node 的断言功能与其他开发语言及环境所提供的功能很类似：允许为对象或函数调用提出要求，并且在破坏断言的时候发出信息。这些方法都很容易使用，并能为代码单元测试提供许多遍历。Node 自己的测试也是用 assert 编写的。

### 5.5 虚拟机

虚拟机（vm）模块可以运行任意一块代码，并得到运行结果。它提供了一些功能，可以修改指定代码运行的上下文。

## 第6章 数据访问

与其他 Web 服务器类似，Node需要通过储存来进行数据持久化。离开了持久化，网站就知识一个宣传性质的静态站点，也就没有必要使用 Node 了。

## 第7章 重要的外部模块

虽然 Node 提供的核心 API 很强大，但其中很多功能还是过于底层。Node 社区构建了许多高级的功能库，大大地方便了开发。虽然这些模块从技术上并不是 Node 本身，但它们对完成工作非常重要，而且其中很多库本身就是成熟的项目。